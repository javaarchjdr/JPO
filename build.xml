<?xml version="1.0"?>
<project name="Java Picture Organizer" default="run">
    
    <property name="app.main.package" value="jpo"/>
    <property name="app.main.class" value="${app.main.package}.Jpo"/>
    
    <property name="build.dir" value="build"/>
    <property name="build.base.classes.dir" value="${build.dir}/classes"/>
    <property name="unit.test.classes.dir" value="${build.dir}/unittestclasses"/>
    <property name="build.images.dir" value="${build.base.classes.dir}/${app.main.package}/images"/>
    <property name="build.dtd.dir" value="${build.base.classes.dir}/${app.main.package}"/>
    <property name="build.docs.dir" value="${build.dir}/docs"/>
    <property name="build.jars.dir" value="${build.dir}/jars"/>
    <property name="version" value="0.8.5"/>
    
    <property name="libs.dir" value="libs"/>
    <property name="src.dir" value="src"/>
    <property name="src.java.dir" value="${src.dir}/java"/>
    <property name="src.images.dir" value="${src.dir}/images"/>
    <property name="src.docs.dir" value="${src.dir}/docsrc"/>
    <property name="src.dtd.dir" value="${src.dir}/dtd"/>
    <property name="results" location="/tmp"/>
    
    <property name="testdir" value="${src.dir}/test/java"/>
    <property name="TALK" value="true" />
    <path id="base.path">
        <pathelement location="${build.base.classes.dir}"/>
        <fileset dir="${libs.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>
    <property environment="env"/>
    
    
    <echo message="${ant.version} is using the "/>
    <echo message="build file ${ant.file} to build the project"/>
    <echo message="&quot;${ant.project.name}&quot; Use the &quot;-debug&quot; switch to see loads of"/>
    <echo message="debug information, &quot;ant --help&quot; reminds you of what other options"/>
    <echo message="there are and &quot;ant -p&quot; tells you what targets this build file supports."/>
    
    <!-- <echo message="The base directory for the project         ${basedir}"/> -->
    <!-- <echo message="The environment's JAVA_HOME is set to:     ${env.JAVA_HOME}"/> -->
    <!-- <echo message="The environment's PATH is set to:          ${env.PATH}"/> -->
    <!-- <echo message="The java source files are being read from: ${src.java.dir}"/> -->
    <!-- <echo message="The compiled Java .class files will go to: ${build.base.classes.dir}"/> -->
    <!-- <echo message="The new jar file will go to:               ${build.jars.dir}"/> -->
    <!-- <echo message="KEYSTORE is set to:                        ${env.KEYSTORE}"/>  -->


    
    <target name="prepare" description="Makes the build directory tree with mkdir">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.base.classes.dir}"/>
        <mkdir dir="${build.docs.dir}"/>
        <mkdir dir="${build.jars.dir}"/>
    </target>
    
    <target name="clean" description="Deletes the build directory and all classes and jars contained in it" >
        <delete verbose="${TALK}">
            <fileset dir="${testdir}" includes="**/*.class" />
        </delete>
        <delete dir="${build.dir}"/>
    </target>
    
    <target name="compile"
            depends="prepare"
            description="Compiles the .java files">
        <javac destdir="${build.base.classes.dir}"
               debug="on"
               optimize="off"
               verbose="off"
               memoryMaximumSize="500m"
               fork="yes"
               listfiles="yes"
               deprecation="yes"
               compiler="modern"
               source="1.5">
            <src path="${src.java.dir}"/>
            <classpath refid="base.path"/>
        </javac>
        <copy todir="${build.images.dir}">
            <fileset dir="${src.images.dir}">
                <include name="**/*.gif"/>
                <include name="**/*.jpg"/>
            </fileset>
        </copy>
        <copy todir="${build.dtd.dir}">
            <fileset dir="${src.dtd.dir}">
                <include name="**/*.dtd"/>
                <include name="**/gpl.txt"/>
            </fileset>
        </copy>
    </target>
    
    
    <target name="javadoc"
            description="Creates the JavaDoc of the project">
        <copy todir="${build.docs.dir}">
            <fileset dir="${src.docs.dir}">
                <include name="**/*.png"/>
            </fileset>
        </copy>
        <javadoc destdir="${build.docs.dir}"
                 packagenames="jpo.*"
                 Overview="${src.docs.dir}/Overview.html"
                 Doctitle="JPO application documentation"
                 Windowtitle="JPO application documentation"
                 Header="JPO application documentation"
                 Bottom="&lt;font size=&quot;-1&quot;&gt;Copyright (c) 2002 - 2007 by Richard Eigenmann &lt;a href=&quot;http://www.lomumba.ch/richi&quot;&gt;wwwlomumba.ch/richi&lt;/a&gt;&lt;/font&gt;"
                 author="true"
                 version="true"
                 use="true"
                 private="true"
                 source="1.5"
                 classpath="libs/metadata-extractor-2.3.0.jar; libs/jnlp.jar; libs/activation.jar; libs/mail.jar" 
        >
            <sourcepath path="${src.java.dir}" />
            <link href="http://java.sun.com/j2se/1.5.0/docs/api/" />
        </javadoc>
    </target>
    
    
    <target name="go"
            depends="compile, run"
            description="Compile and run the project"/>
    
    
    <target name="buildjar" depends="compile, test" description="Builds the  file containing the Jpo Classes">
        <jar destfile="${build.jars.dir}/jpo-${version}.jar"
             basedir="${build.base.classes.dir}"
             compress="yes"
             duplicate="fail" >
            <manifest>
                <attribute name="Main-Class" value="${app.main.class}"/>
                <attribute name="Class-Path" value="metadata-extractor-2.3.0.jar jnlp.jar activation.jar mail.jar" />
                <section name="Copyright">
                    <attribute name="Copy" value="(c) 2001-2007, Richard Eigenmann, ZÃ¼rich, Switzerland"/>
                </section>
            </manifest>
        </jar>
        <copy todir="${build.jars.dir}">
            <fileset dir="${libs.dir}">
                <include name="**/*.jar"/>
            </fileset>
        </copy>
    </target>
    
    
    <!-- This target will only be of use to the person who wants to sign the jar file for deployment on a web server.
         It relies on the environment variables KEYSTORE and JARPWD to find the keystore and password to access this
	 buildjar
    -->
    <target name="signjar" depends="buildjar" description="Signs the jpo-${version}.jar jar file with the key in the keystore ${env.KEYSTORE} using the password ${env.JARPWD}">
        <signjar jar="${build.jars.dir}/jpo-${version}.jar" 
                 alias="richi"
                 keystore="${env.KEYSTORE}"
                 storepass="${env.JARPWD}"
        />
        <signjar jar="${build.jars.dir}/metadata-extractor-2.3.0.jar" 
                 alias="richi"
                 keystore="${env.KEYSTORE}"
                 storepass="${env.JARPWD}"
        />
    </target>
    
    <target name="runjar" description="Runs the program from the jar" depends="buildjar">
        <java jar="${build.jars.dir}/jpo-${version}.jar"
              fork="yes"
              maxmemory="1000m">
        </java>
    </target>
    
    
    
    <!-- This target will only be of use to the person who does the deployment of JPO to souceforge.
         It relies on the environment variables SOURCEFORGEUSER and SORUVEFORGEPWD for the authentication.
    -->
    <target name="publish" depends="signjar" description="Publishes the lates Jpo Version to the SourceForge project">
        <scp localfile="web/index.html" 
             todir="${env.SOURCFORGEUSER}:${env.SOURCFORGEPWD}@shell.sourceforge.net:/home/groups/j/j-/j-po/htdocs"
             trust="yes"
             verbose="no" >
            <fileset dir="web">
                <include name="**/*.html"/>
                <include name="**/*.jnlp"/>
                <include name="**/fontconfig"/>
            </fileset>
            <!-- <fileset dir="${build.jars.dir}">
                        <include name="**/*.jar"/>
                    </fileset>  -->
        </scp>
    </target>    
    
    
    <target name="run" description="Runs the program" depends="compile">
        <java classname="${app.main.class}"
              fork="yes"
              maxmemory="1000m" >
            <classpath refid="base.path"/>
        </java>
    </target>
    
    
    
    
    
    
    
    
    <target name="compile-test" depends="JUNIT, compile" description="Compiles the JUnit test cases">
        <mkdir dir="${unit.test.classes.dir}"/>
        <javac srcdir="${testdir}"
               verbose="${TALK}"
               destdir="${unit.test.classes.dir}"
               classpath="${build.base.classes.dir}"
        >
        </javac>
    </target>
    
    
    <target name="test-direct" description="Run individual Unit tests" depends="compile-test" >
        <property name="junit-text" value="junit.textui.TestRunner"/>
        <property name="junit-swing" value="junit.swingui.TestRunner"/>
        <java fork="true" classname="${junit-text}"
              taskname="junit" failonerror="true">
            <arg value="jpo.CategoryTest" />
            <arg value="jpo.ApplicationJMenuBarTest" />
            <classpath>
                <pathelement location="${build.base.classes.dir}" />
                <pathelement location="${unit.test.classes.dir}" />
                <pathelement path="" />
                <pathelement path="${java.class.path}" />
            </classpath>
        </java>
    </target>
    
    
    <target name="test" depends="compile-test" description="Runs the unit tests">
        <junit
            printsummary="yes"
            errorProperty="test.failed"
            failureproperty="test.failed"
            haltonfailure="yes" 
            fork="yes"
            showoutput="yes">
            <formatter type="plain" usefile="false"/>
            <classpath>
                <pathelement location="${build.base.classes.dir}" />
                <pathelement location="${unit.test.classes.dir}" />
                <pathelement path="libs/metadata-extractor-2.3.0.jar; libs/jnlp.jar; libs/activation.jar; libs/mail.jar" />
            </classpath>
            <!--<test todir="${results}" name="jpo.ApplicationJMenuBarTest"/>-->
            <batchtest todir="${results}">
                <fileset dir="${unit.test.classes.dir}">
                    <include name="**/*Test.class"/>
                </fileset>
            </batchtest>
        </junit>
        <fail message="Tests failed!" if="test.failed"/>
    </target>
    
    
    <target name="JUNIT" description="Checks if JUnit is available">
        <available property="junit.present" classname="junit.framework.TestCase" />
    </target>
    
    <target name="JSCH" description="Checks if JSch is available">
        <available property="jsch.present" classname="jsch.JSCh" />
    </target>
    
    
    <!-- <property name="cvsroot" value=":ext:richieigenmann@j-po.cvs.sourceforge.net:/cvsroot/j-po"/> -->
    <property name="cvsroot" value=":pserver:anonymous@j-po.cvs.sourceforge.net:/cvsroot/j-po"/>
    
    <target name="cvscheckout" description="Checks out a new version of the Jpo source from Sourceforge">
        <!-- Sourceforge doesn't use .cvspass instead uses the user's ssh public key <cvspass cvsroot="${cvsroot}" password="${SOURCEFORGEPWD}"/> -->
        <cvs cvsroot="${cvsroot}" command="checkout Jpo"/>
    </target>
    
    <target name="cvsupdate" description="Updates the Jpo source from Sourceforge">
        <!-- Sourceforge doesn't use .cvspass instead uses the user's ssh public key <cvspass cvsroot="${cvsroot}" password="${SOURCEFORGEPWD}"/> -->
        <cvs cvsroot="${cvsroot}" command="update -P"/>
    </target>
    
    <target name="cvscommit" description="Updates the Jpo source from Sourceforge">
        <!-- Sourceforge doesn't use .cvspass instead uses the user's ssh public key <cvspass cvsroot="${cvsroot}" password="${SOURCEFORGEPWD}"/> -->
        <cvs cvsroot="${cvsroot}" command="commit"/>
    </target>
    
</project>
